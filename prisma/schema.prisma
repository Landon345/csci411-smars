// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Roles {
  patient
  doctor
  admin
}

enum RecordType {
  office_visit
  lab_result
  imaging
  referral
  procedure_note
}

enum AppointmentStatus {
  pending
  scheduled
  completed
  canceled
  no_show
}

enum AppointmentType {
  checkup
  follow_up
  consultation
  procedure
  emergency
}

enum PrescriptionStatus {
  active
  completed
  discontinued
}

enum ClinicalCategory {
  primary_care
  mental_health
  surgical_specialist
  medical_specialist
  urgent_emergency
}

enum MedicalDegree {
  MD
  DO
  NP
  PA
}

enum AuditAction {
  login_success
  login_failure
  logout
  account_locked
  record_viewed
  record_created
  record_updated
  prescription_created
  prescription_updated
  password_changed
  role_changed
  invite_created
  invite_used
}

model User {
  UserID        String    @id @default(uuid())
  Email         String    @unique @db.VarChar(255)
  Password      String?   @db.VarChar(255)
  FirstName     String    @db.VarChar(255)
  LastName      String    @db.VarChar(255)
  Phone         String?   @db.VarChar(23)
  SSN           String    @unique @db.VarChar(500)
  Role          Roles     @default(patient)
  CreatedAt     DateTime  @default(now()) @db.Timestamp(6)
  UpdatedAt     DateTime  @updatedAt
  EmailVerified DateTime? // Null means not verified
  VerifyCode      String?   @db.VarChar(6) // The 6-digit code
  VerifyExpires   DateTime? // When the code expires
  VerifyAttempts  Int       @default(0)
  ResetToken      String?   // Password reset token (UUID)
  ResetExpires    DateTime? // When the reset token expires
  FailedAttempts  Int       @default(0)
  LockedUntil     DateTime? // Non-null means account is locked until this time
  DoctorAppointments  Appointment[] @relation("DoctorAppointments")
  PatientAppointments Appointment[] @relation("PatientAppointments")
  DoctorRecords       MedicalRecord[] @relation("DoctorRecords")
  PatientRecords      MedicalRecord[] @relation("PatientRecords")
  DoctorPrescriptions   Prescription[] @relation("DoctorPrescriptions")
  PatientPrescriptions  Prescription[] @relation("PatientPrescriptions")
  AuditLogs             AuditLog[]
  InvitesCreated        InviteToken[] @relation("InviteCreator")
  DoctorProfile         DoctorProfile? @relation("DoctorProfile")

  @@index([FirstName, CreatedAt(sort: Desc)])
  @@index([LastName, CreatedAt(sort: Desc)])
  @@index([Password, CreatedAt(sort: Desc)])
}

model Appointment {
  AppointmentID String            @id @default(uuid())
  DoctorID      String
  PatientID     String
  Doctor        User              @relation("DoctorAppointments", fields: [DoctorID], references: [UserID])
  Patient       User              @relation("PatientAppointments", fields: [PatientID], references: [UserID])
  Date          DateTime          @db.Date
  StartTime     DateTime          @db.Time(6)
  EndTime       DateTime          @db.Time(6)
  Place         String            @db.VarChar(255)
  Reason        String            @db.VarChar(500)
  Type          AppointmentType   @default(checkup)
  Status        AppointmentStatus @default(scheduled)
  Notes         String?           @db.Text
  CanceledBy    String?           @db.VarChar(255)
  VisitSummary  String?           @db.Text
  ReminderSent  Boolean           @default(false)
  CreatedAt     DateTime          @default(now()) @db.Timestamp(6)
  UpdatedAt     DateTime          @updatedAt
  MedicalRecord MedicalRecord[]

  @@index([DoctorID, Date])
  @@index([PatientID, Date])
}

model MedicalRecord {
  RecordID       String       @id @default(uuid())
  DoctorID       String
  PatientID      String
  AppointmentID  String?
  Doctor         User         @relation("DoctorRecords", fields: [DoctorID], references: [UserID])
  Patient        User         @relation("PatientRecords", fields: [PatientID], references: [UserID])
  Appointment    Appointment? @relation(fields: [AppointmentID], references: [AppointmentID])
  VisitDate      DateTime   @db.Date
  ChiefComplaint String     @db.VarChar(500)
  DiagnosisCode  String     @db.VarChar(10)
  DiagnosisDesc  String     @db.VarChar(500)
  TreatmentPlan  String     @db.Text
  HeartRate      Int?
  BloodPressure  String?    @db.VarChar(7)
  Temperature    Decimal?   @db.Decimal(4, 1)
  Weight         Decimal?   @db.Decimal(5, 1)
  Height         Decimal?   @db.Decimal(5, 1)
  FollowUp       String?    @db.Text
  Type           RecordType @default(office_visit)
  CreatedAt      DateTime   @default(now()) @db.Timestamp(6)
  UpdatedAt      DateTime   @updatedAt

  @@index([DoctorID, VisitDate])
  @@index([PatientID, VisitDate])
}

model Prescription {
  PrescriptionID  String               @id @default(uuid())
  DoctorID        String
  PatientID       String
  Doctor          User                 @relation("DoctorPrescriptions", fields: [DoctorID], references: [UserID])
  Patient         User                 @relation("PatientPrescriptions", fields: [PatientID], references: [UserID])
  RecordID        String?
  AppointmentID   String?
  Medication      String               @db.VarChar(255)
  Dosage          String               @db.VarChar(100)
  Frequency       String               @db.VarChar(100)
  Duration        String               @db.VarChar(100)
  Refills         Int                  @default(0)
  StartDate       DateTime             @db.Date
  EndDate         DateTime?            @db.Date
  Status          PrescriptionStatus   @default(active)
  Notes           String?              @db.Text
  CreatedAt       DateTime             @default(now()) @db.Timestamp(6)
  UpdatedAt       DateTime             @updatedAt

  @@index([DoctorID, StartDate])
  @@index([PatientID, StartDate])
}

model AuditLog {
  LogID     String      @id @default(uuid())
  UserID    String?
  User      User?       @relation(fields: [UserID], references: [UserID])
  Action    AuditAction
  IPAddress String      @db.VarChar(45)
  Details   String?     @db.Text
  CreatedAt DateTime    @default(now()) @db.Timestamp(6)

  @@index([CreatedAt(sort: Desc)])
  @@index([UserID, CreatedAt(sort: Desc)])
  @@index([Action, CreatedAt(sort: Desc)])
}

model InviteToken {
  TokenID   String   @id @default(uuid())
  Email     String   @db.VarChar(255)
  Token     String   @unique @db.VarChar(64)
  Used      Boolean  @default(false)
  ExpiresAt DateTime
  CreatedBy String
  CreatedAt DateTime @default(now()) @db.Timestamp(6)
  Creator   User     @relation("InviteCreator", fields: [CreatedBy], references: [UserID])
}

model DoctorProfile {
  ProfileID        String            @id @default(uuid())
  UserID           String            @unique
  User             User              @relation("DoctorProfile", fields: [UserID], references: [UserID])
  ClinicalCategory ClinicalCategory?
  Specialty        String?           @db.VarChar(255)
  Degree           MedicalDegree?
  BoardCertified   Boolean           @default(false)
  SubSpecialties   String[]
  Bio              String?           @db.Text
  Telehealth       Boolean           @default(false)
  UpdatedAt        DateTime          @updatedAt
}
